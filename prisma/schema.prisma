generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Exam {
  id             String           @id
  examDate       DateTime
  location       String
  technicianName String
  status         String           @default("pending")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  eyerCloudId    String?
  patientId      String
  patient        Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  images         ExamImage[]
  report         MedicalReport?
  referral       PatientReferral?
}

model ExamImage {
  id         String   @id
  url        String
  fileName   String
  type       String?
  uploadedAt DateTime @default(now())
  examId     String
  Exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
}

model HealthUnit {
  id          String   @id
  name        String   @unique
  address     String
  email       String
  phone       String
  responsible String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model MedicalReport {
  id                   String   @id
  doctorName           String
  findings             String
  diagnosis            String
  recommendations      String
  diagnosticConditions Json
  completedAt          DateTime @default(now())
  selectedImages       Json?
  suggestedConduct     String?
  doctorCRM            String?
  driveFileId          String?
  syncedToDrive        Boolean  @default(false)
  examId               String   @unique
  exam                 Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  history              SelectedImagesHistory[]
}

model SelectedImagesHistory {
  id              String        @id @default(cuid())
  reportId        String
  report          MedicalReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  previousImages  Json?
  newImages       Json?
  changedBy       String
  reason          String?
  createdAt       DateTime      @default(now())
}

model Patient {
  id                 String    @id
  name               String
  cpf                String?
  birthDate          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  education          String?
  ethnicity          String?
  gender             String?
  occupation         String?
  phone              String?
  ophthalmicDiseases Json?
  underlyingDiseases Json?
  exams              Exam[]
}

model PatientReferral {
  id                 String    @id
  referredBy         String
  referralDate       DateTime  @default(now())
  specialty          String
  urgency            String
  notes              String
  status             String    @default("pending")
  outcome            String?
  outcomeDate        DateTime?
  specializedService String?
  scheduledDate      DateTime?
  examId             String    @unique
  Exam               Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
}
