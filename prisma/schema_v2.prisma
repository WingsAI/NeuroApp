// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Representa a pessoa física (paciente único)
model Patient {
  id             String    @id @default(cuid())
  name           String
  cpf            String?   // Tornamos opcional para dados importados sem CPF
  birthDate      DateTime?
  gender         String?
  ethnicity      String?
  education      String?
  occupation     String?
  phone          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  underlyingDiseases Json?
  ophthalmicDiseases Json?
  
  // Um paciente pode ter múltiplos exames/visitas
  exams          Exam[]
}

// Representa cada visita/exame do paciente
model Exam {
  id             String           @id @default(cuid())
  examDate       DateTime
  location       String
  technicianName String
  status         String           @default("pending") // pending, in_analysis, completed
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  // EyerCloud exam ID for reference
  eyerCloudId    String?
  
  patientId      String
  patient        Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  images         ExamImage[]
  report         MedicalReport?
  referral       PatientReferral?
}

model ExamImage {
  id         String   @id @default(cuid())
  url        String   // URL to Bytescale/S3
  fileName   String
  type       String?  // COLOR or ANTERIOR
  uploadedAt DateTime @default(now())
  
  examId     String
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
}

model MedicalReport {
  id                   String   @id @default(cuid())
  doctorName           String
  doctorCRM            String?
  findings             String
  diagnosis            String
  recommendations      String
  suggestedConduct     String?
  diagnosticConditions Json
  selectedImages       Json?
  completedAt          DateTime @default(now())
  
  syncedToDrive        Boolean  @default(false)
  driveFileId          String?
  
  examId               String   @unique
  exam                 Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
}

model PatientReferral {
  id                 String    @id @default(cuid())
  referredBy         String
  referralDate       DateTime  @default(now())
  specialty          String
  urgency            String    // routine, urgent, emergency
  notes              String
  specializedService String?
  outcome            String?
  outcomeDate        DateTime?
  scheduledDate      DateTime?
  status             String    @default("pending")
  
  examId             String    @unique
  exam               Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
}

model HealthUnit {
  id          String   @id @default(cuid())
  name        String   @unique
  address     String
  email       String
  phone       String
  responsible String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
