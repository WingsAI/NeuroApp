# Session 2026-02-08 - Disease Data, Report Navigation & Data Integrity Fixes

## Summary

Major data integrity and UI fixes session. Migrated from Claude Desktop. Fixed 5 bugs affecting the medical workflow.

## Bugs Fixed

### 1. Report navigation after save
- **File:** `app/medical/page.tsx`
- **Problem:** After signing a report, the page reloaded the patient list instead of navigating to results
- **Fix:** Changed to `router.push('/results')` after successful save

### 2. Disease/comorbidity data missing
- **Files:** `scripts/eyercloud_downloader/fetch_anamnesis.py`, `scripts/fix_diseases.js`, `app/actions/patients.ts`
- **Problem:** All patient diseases showed as false. Root-level EyerCloud API fields are always false; real data is in `patient.anamnesis` field from `POST /patient/list`
- **Fix:** Rewrote fetch_anamnesis.py to use correct API, synced 414 patients with real disease data, added disease persistence to updatePatientAction
- **Result:** 415 patients now have disease flags

### 3. Cloud mapping phantom patients in pending list
- **File:** `app/medical/page.tsx`
- **Problem:** 382 cloud mapping entries with short 8-char IDs didn't match DB patients, appearing as phantom pending entries
- **Fix:** Added name-based matching alongside ID matching when merging cloud and DB patients

### 4. Broken images in results page
- **File:** `app/results/page.tsx`
- **Problem:** 105 reports had selectedImages with stale IDs (cloud mapping format `examId-N`) that didn't match current DB image IDs (`img-UUID.jpg`)
- **Fix:** Added `resolveImage()` function with 3-tier fallback: exact match, cross-exam search, index-based positional match

### 5. Duplicate CML exams in both lists
- **File:** `scripts/fix_duplicate_cml_status.js`
- **Problem:** 34 patients appeared in both pending and completed lists because CML duplicate exams stayed pending
- **Fix:** Script marks all pending duplicates as completed when patient has at least one completed exam

## Key Discoveries

### EyerCloud API Structure
- `POST /patient/list` with `{page: N}` - returns patients with `anamnesis` field (the ONLY source of real disease data)
- `POST /examData/list?id=ID` - returns images only, NOT patient data (exam.patient is just an ID string)
- Anamnesis field names: `diabetes`, `hipertensaoArterial`, `hipercolesterolemia`, `tabagismo`, `catarata`, `retinopatia`, `glaucoma`

### Cloud Mapping Issues
- 382 of 538 entries have short 8-char IDs (folder key names), no `exam_id` field
- These don't match any DB patient IDs (24-char)
- Must match by normalized name, not just ID

### selectedImages ID Format Mismatch
- Reports store IDs in format: `examId-N` (cloud mapping) or `cml...-N` (CML)
- DB images have format: `img-UUID.jpg` (S3 uploads)
- The resolveImage fallback handles this gracefully

## DB State After Session
- 449 patients, 518 exams, 4726 images, 330 reports
- 364 completed, 154 pending exams
- 415 patients with at least one disease flag
- Snapshot: `scripts/db_snapshots/snapshot_2026-02-08_2316.json`

## Scripts Created
- `scripts/eyercloud_downloader/fetch_anamnesis.py` - rewritten to use patient/list API
- `scripts/fix_diseases.js` - sync diseases from download_state to DB
- `scripts/fix_duplicate_cml_status.js` - mark CML duplicates as completed
- Multiple temp scripts (can be cleaned up): temp_check_*.js, temp_stats.js, temp_fix_*.js

## Pending Items
- Birth dates with errors mentioned by user but not yet investigated
- Temp scripts in scripts/ folder should be cleaned up
